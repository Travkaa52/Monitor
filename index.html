<!DOCTYPE html>
<html lang="uk">
<head>
  <script>
  document.documentElement.classList.add('viewer-no-auth');
</script>

  <meta charset="UTF-8" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https: data: blob:; img-src 'self' https: data: blob:;">
  <title>Sky Kharkiv Map ‚Äî Viewer</title>

  <script src="config.dev.js?v=20260206-15"></script>
<script>
/* ===== Polling: –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ü—ñ–ª–µ–π –∫–æ–∂–Ω—ñ 5—Å ===== */
function ensureDebugEl(){
  let el = document.getElementById('tgDebug');
  if (!el && document.body) {
    el = document.createElement('div');
    el.id = 'tgDebug';
    el.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
    document.body.appendChild(el);
  }
  return el;
}

setInterval(async () => {
  try {
    // –î–æ–¥–∞—î–º–æ timestamp, —â–æ–± GitHub –Ω–µ –∫–µ—à—É–≤–∞–≤ —Å—Ç–∞—Ä—ñ –¥–∞–Ω—ñ
    const response = await fetch(`./targets.json?t=${Date.now()}`); 
    const data = await response.json();
    if (typeof updateMapData === 'function' && map) {
      updateMapData(data);
    }
  } catch (e) {
    console.warn('[Viewer] fetch error:', e);
  }
}, 5000);
    const data = await response.json();
    if (typeof updateMapData === 'function' && map) {
      updateMapData(data);
    }
  } catch (e) {
    console.warn('[Viewer] fetch error:', e);
  }
}, 5000);
</script>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="favicon.png" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.js"></script>

  <style>
:root {
  --panel-bg: rgba(8, 13, 18, 0.96);
  --panel-text: #f4f7ff;
  --route-main: #79ff9a;
  --route-shadow: #020409;
  --btn-primary: #2fbf71;
  --card-bg: rgba(11, 17, 24, 0.96);
  --card-border: rgba(123, 255, 171, 0.20);
  --card-hover: rgba(123, 255, 171, 0.12);
  --card-active: rgba(123, 255, 171, 0.20);
  --glow:
    drop-shadow(0 0 0.6px #ffb347)
    drop-shadow(0 0 3px   #ffb347)
    brightness(1.05)
    contrast(1.05);
  --map-overlay-br: brightness(1.06) contrast(1.05);
}

html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; font-family:system-ui,"Segoe UI",sans-serif; background:#0a0e14; color:var(--panel-text); }
#map { position:relative; width:100vw; height:100vh; height:100dvh; background:#0a0e14; }
.leaflet-container { background:#0a0e14 !important; }

/* –†–∞–¥–∞—Ä–Ω–∞ —Å—ñ—Ç–∫–∞ */
#map::before {
  content:""; position:absolute; inset:0; pointer-events:none; z-index:8;
  background-image:
    repeating-linear-gradient(0deg, rgba(123,255,171,0.06) 0px, rgba(123,255,171,0.06) 1px, transparent 1px, transparent 32px),
    repeating-linear-gradient(90deg, rgba(123,255,171,0.06) 0px, rgba(123,255,171,0.06) 1px, transparent 1px, transparent 32px);
  mix-blend-mode:soft-light; opacity:0.55;
}
#map::after {
  content:""; position:absolute; inset:0; pointer-events:none; z-index:5;
  background: radial-gradient(circle at 50% 50%, transparent 0%, transparent 55%, rgba(0,0,0,0.55) 100%);
}
.leaflet-pane, .leaflet-control-container { position:relative; z-index:9; }

/* –°—Ç–∞—Ç—É—Å-–±–∞—Ä –∑–≤–µ—Ä—Ö—É */
#statusBar {
  position:absolute; top:10px; left:50%; transform:translateX(-50%);
  padding:5px 14px; background:linear-gradient(135deg,rgba(5,10,16,0.95),rgba(8,14,22,0.95));
  color:var(--panel-text); font:600 12px/1 system-ui; letter-spacing:.06em; text-transform:uppercase;
  border-radius:999px; border:1px solid rgba(123,255,171,0.5);
  box-shadow: 0 0 0 1px rgba(0,0,0,0.85), 0 8px 18px rgba(0,0,0,0.7);
  z-index:1100; pointer-events:auto; cursor:pointer; backdrop-filter:blur(6px);
  transition: box-shadow .2s, border-color .2s;
}
#statusBar:active { border-color:rgba(123,255,171,0.8); box-shadow:0 0 0 1px rgba(0,0,0,0.85), 0 0 12px rgba(123,255,171,0.3); }
#statusBar::before { content:"‚ñ†"; font-size:10px; margin-right:6px; color:#7bffab; text-shadow:0 0 4px #7bffab; }

/* Toast –¥–ª—è –Ω–æ–≤–∏—Ö —Ü—ñ–ª–µ–π */
#newTargetToast {
  position:fixed; top:56px; left:50%; transform:translateX(-50%) translateY(-120%);
  padding:8px 18px; border-radius:12px;
  background:linear-gradient(135deg,rgba(5,10,16,0.95),rgba(8,14,22,0.95));
  color:#7bffab; font:600 13px/1.3 system-ui; letter-spacing:.03em;
  border:1px solid rgba(123,255,171,0.45);
  box-shadow:0 4px 20px rgba(0,0,0,0.6), 0 0 8px rgba(123,255,171,0.15);
  z-index:1200; pointer-events:auto; cursor:pointer;
  backdrop-filter:blur(8px);
  opacity:0; transition: transform .35s cubic-bezier(.4,0,.2,1), opacity .35s;
  white-space:nowrap;
}
#newTargetToast.show {
  transform:translateX(-50%) translateY(0); opacity:1;
}
#newTargetToast::before { content:"‚ö†"; margin-right:6px; }

/* Donate toast */
#donateToast {
  position:fixed; bottom:68px; right:16px; z-index:10002;
  padding:10px 18px; border-radius:14px;
  background:linear-gradient(135deg,rgba(10,14,20,0.92),rgba(18,22,30,0.92));
  color:#ffc83c; font:600 13px/1.3 system-ui; letter-spacing:.02em;
  border:1px solid rgba(255,200,60,0.35);
  box-shadow:0 4px 20px rgba(0,0,0,0.5), 0 0 10px rgba(255,200,60,0.08);
  pointer-events:auto; cursor:pointer; backdrop-filter:blur(8px);
  opacity:0; transform:translateY(12px) scale(0.95);
  transition: opacity .4s cubic-bezier(.4,0,.2,1), transform .4s cubic-bezier(.4,0,.2,1);
  text-decoration:none; display:flex; align-items:center; gap:8px;
  white-space:nowrap;
}
#donateToast.show {
  opacity:1; transform:translateY(0) scale(1);
}
#donateToast .dt-icon { font-size:16px; }
#donateToast .dt-close {
  margin-left:6px; opacity:0.5; font-size:14px; transition:opacity .2s;
}
#donateToast .dt-close:hover { opacity:1; }
@media (max-width:640px){
  #donateToast { bottom:58px; right:12px; font-size:12px; padding:8px 14px; }
}

/* –î–µ–±–∞–≥-—Å—Ç–∞—Ç—É—Å –∑–Ω–∏–∑—É */
#tgDebug {
  position:fixed; right:10px; bottom:10px; z-index:9999;
  padding:6px 10px; border-radius:8px;
  background:rgba(10,14,20,0.75); color:#e8f0ff;
  font:600 12px/1.2 system-ui; border:1px solid rgba(255,255,255,0.15);
  pointer-events:none;
}

/* –ö–Ω–æ–ø–∫–∞ —Ä–µ—Ü–µ–Ω—Ç—Ä—É */
.recenter-btn {
  position:fixed; right:12px; bottom:58px; z-index:9999;
  width:42px; height:42px; border-radius:10px;
  border:1px solid rgba(121,255,154,0.35);
  background:rgba(8,12,16,0.65); color:#79ff9a; cursor:pointer;
  font-size:0; backdrop-filter:blur(4px);
  box-shadow:0 6px 14px rgba(0,0,0,0.45);
  background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2379ff9a' stroke-width='1.5'><circle cx='12' cy='12' r='7'/><line x1='12' y1='2' x2='12' y2='6'/><line x1='12' y1='18' x2='12' y2='22'/><line x1='2' y1='12' x2='6' y2='12'/><line x1='18' y1='12' x2='22' y2='12'/></svg>");
  background-repeat:no-repeat; background-position:center;
}
.recenter-btn:active { transform:translateY(1px); }

/* –†–°–ó–û –ø—ñ–¥–ø–∏—Å */
.rszo-tag {
  background:rgba(5,10,16,0.82); color:#f4f7ff;
  border:1px solid rgba(255,60,80,0.55); border-radius:10px; padding:2px 7px;
  font:700 11px/1 system-ui; letter-spacing:.04em; text-transform:uppercase;
  box-shadow:0 0 0 1px rgba(0,0,0,0.8), 0 6px 12px rgba(0,0,0,0.55);
  pointer-events:none; white-space:nowrap;
}

/* –Ü–∫–æ–Ω–∫–∏ –º–∞—Ä–∫–µ—Ä—ñ–≤ */
.leaflet-marker-icon { filter:var(--glow); }
.leaflet-overlay-pane canvas { filter:var(--map-overlay-br); }
.drone-label { font-size:10px; padding:1px 4px; border-radius:4px; background:rgba(255,255,255,.55); color:#ff3; text-shadow:0 0 3px #000; pointer-events:none; }
.drone-label.light { background:rgba(0,0,0,.55); color:#fff; text-shadow:0 0 2px #f33; }

/* ===== –î–æ–∫ –ø—ñ–¥–∫–ª–∞–¥–æ–∫ –∫–∞—Ä—Ç–∏ (–ª—ñ–≤–∏–π –≤–µ—Ä—Ö–Ω—ñ–π –∫—É—Ç) ===== */
.basemap-switcher { position:absolute; left:12px; top:12px; z-index:1100; }
.bm-fab {
  width:34px; height:34px; border-radius:999px; border:none; cursor:pointer;
  font-size:18px; display:flex; align-items:center; justify-content:center;
  background:var(--panel-bg); color:var(--panel-text);
  box-shadow:0 4px 14px rgba(0,0,0,.35);
}
.bm-fab:hover { background:var(--card-hover); }
.bm-panel {
  position:absolute; left:0; top:42px; transform:translateY(8px);
  opacity:0; pointer-events:none; transition:opacity .15s, transform .15s;
  background:rgba(255,255,255,0.95); color:#1a1a1a;
  border:1px solid rgba(0,0,0,0.15); border-radius:12px;
  box-shadow:0 4px 14px rgba(0,0,0,.25); padding:8px 8px 6px;
  max-width:280px; backdrop-filter:blur(6px);
}
.basemap-switcher.open .bm-panel, .basemap-switcher:hover .bm-panel {
  opacity:1; transform:translateY(0); pointer-events:auto;
}
.bm-title { font:600 11px/1 system-ui; text-transform:uppercase; letter-spacing:.04em; color:#555; margin:0 0 4px 2px; }
.bm-list { display:flex; flex-wrap:wrap; gap:6px; }
.bm-item {
  flex:1 1 120px; min-width:120px; max-width:100%; border-radius:10px;
  border:1px solid rgba(0,0,0,0.12); background:rgba(245,245,245,0.9); color:#1a1a1a;
  padding:6px 8px; text-align:left; cursor:pointer;
  display:flex; flex-direction:column; gap:2px;
  transition:background .15s, border-color .15s; font:400 12px/1.1 system-ui;
}
.bm-item:hover { background:rgba(230,230,230,0.95); }
.bm-item.active { border-color:#0d6efd; background:rgba(220,235,255,0.95); box-shadow:0 0 0 2px rgba(13,110,253,.35) inset; }
.bm-name { font-weight:600; font-size:12px; color:#1a1a1a; }
.bm-sub { font-size:11px; color:#555; }

/* –ü–æ–ø–∞–ø –Ω–∞–∑–≤–∏ —Ü—ñ–ª—ñ */
.target-popup .leaflet-popup-content-wrapper {
  background:rgba(5,10,16,0.92); color:#f4f7ff; border:1px solid rgba(123,255,171,0.4);
  border-radius:8px; box-shadow:0 4px 14px rgba(0,0,0,0.5); font:600 13px/1.2 system-ui;
  padding:0;
}
.target-popup .leaflet-popup-content { margin:6px 10px; }
.target-popup .leaflet-popup-tip { background:rgba(5,10,16,0.92); border:1px solid rgba(123,255,171,0.4); border-top:none; border-left:none; }

/* –ó–∞–≥–ª—É—à–∫–∞ ¬´–ö–∞—Ä—Ç–∞ –≤–∏–º–∫–Ω–µ–Ω–∞¬ª */
#streamOffline {
  display:none; position:fixed; inset:0; z-index:99999;
  background:linear-gradient(160deg, #0a0e14 0%, #111820 50%, #0a0e14 100%);
  flex-direction:column; align-items:center; justify-content:center; text-align:center;
  padding:32px;
}
#streamOffline.visible { display:flex; }
#streamOffline .offline-icon { font-size:64px; margin-bottom:20px; opacity:0.7; }
#streamOffline h1 {
  font:700 22px/1.3 system-ui; color:#ff6b6b; text-transform:uppercase;
  letter-spacing:.08em; margin:0 0 16px;
}
#streamOffline p {
  font:400 14px/1.6 system-ui; color:rgba(244,247,255,0.7);
  max-width:360px; margin:0;
}

@media (max-width:640px) {
  .basemap-switcher { left:8px; top:8px; }
}

/* ===== DONATE BUTTON ===== */
#donateBtn{
  position:fixed;bottom:16px;right:16px;z-index:10001;
  height:42px;padding:0 16px;
  border-radius:999px;border:1px solid rgba(255,200,60,0.45);
  background:rgba(10,14,20,0.8);backdrop-filter:blur(8px);
  color:#ffc83c;font:600 13px/1 system-ui;cursor:pointer;
  display:flex;align-items:center;gap:8px;
  transition:all .25s;box-shadow:0 2px 12px rgba(0,0,0,0.4);
  text-decoration:none;
}
#donateBtn:hover{background:rgba(255,200,60,0.15);transform:scale(1.05)}
#donateBtn .donate-icon{font-size:18px}
#donateBtn .donate-label{letter-spacing:.03em}
@media (max-width:640px){
  #donateBtn{bottom:12px;right:12px;height:38px;padding:0 12px;font-size:12px}
}

/* ===== CHANGELOG BUTTON & MODAL ===== */
#changelogBtn{
  position:fixed;bottom:16px;left:16px;z-index:10001;
  width:40px;height:40px;border-radius:50%;border:1px solid rgba(123,255,171,0.35);
  background:rgba(10,14,20,0.75);backdrop-filter:blur(8px);
  color:#7bffab;font-size:16px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:all .25s;box-shadow:0 2px 12px rgba(0,0,0,0.4);
}
#changelogBtn:hover{background:rgba(123,255,171,0.15);transform:scale(1.1)}

#changelogOverlay{
  display:none;position:fixed;inset:0;z-index:100002;
  background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);
  align-items:center;justify-content:center;padding:16px;
}
#changelogOverlay.open{display:flex}

#changelogModal{
  background:linear-gradient(135deg,#0d1117 0%,#161b22 100%);
  border:1px solid rgba(123,255,171,0.2);border-radius:16px;
  color:#e6edf3;width:100%;max-width:640px;max-height:85vh;
  display:flex;flex-direction:column;
  box-shadow:0 8px 40px rgba(0,0,0,0.6);overflow:hidden;
}
#changelogModal .cl-header{
  padding:20px 24px 16px;border-bottom:1px solid rgba(123,255,171,0.12);
  display:flex;align-items:center;justify-content:space-between;flex-shrink:0;
}
#changelogModal .cl-header h2{
  margin:0;font:700 18px/1.3 system-ui,sans-serif;color:#7bffab;
  display:flex;align-items:center;gap:8px;
}
#changelogModal .cl-close{
  background:none;border:none;color:#8b949e;font-size:22px;cursor:pointer;
  width:32px;height:32px;display:flex;align-items:center;justify-content:center;
  border-radius:8px;transition:all .2s;
}
#changelogModal .cl-close:hover{background:rgba(255,255,255,0.1);color:#fff}
#changelogModal .cl-body{
  overflow-y:auto;padding:8px 24px 24px;flex:1;-webkit-overflow-scrolling:touch;
}
#changelogModal .cl-body::-webkit-scrollbar{width:4px}
#changelogModal .cl-body::-webkit-scrollbar-thumb{background:rgba(123,255,171,0.2);border-radius:2px}

.cl-group{margin-bottom:20px}
.cl-group-title{
  font:700 13px/1 system-ui;color:#7bffab;text-transform:uppercase;letter-spacing:.08em;
  margin:0 0 10px;padding-bottom:6px;border-bottom:1px solid rgba(123,255,171,0.1);
  display:flex;align-items:center;gap:6px;
}
.cl-item{
  padding:8px 12px;margin-bottom:6px;
  background:rgba(255,255,255,0.03);border-radius:10px;
  border-left:3px solid rgba(123,255,171,0.25);transition:background .2s;
}
.cl-item:hover{background:rgba(123,255,171,0.06)}
.cl-item-title{font:600 13px/1.4 system-ui;color:#e6edf3;margin-bottom:2px}
.cl-item-desc{font:400 12px/1.5 system-ui;color:#8b949e}
.cl-version{
  text-align:center;padding:12px 0 6px;
  font:600 11px/1 system-ui;color:#484f58;letter-spacing:.06em;
}
/* ===== VIEWER COUNTER ===== */
#viewerCounter{
  position:fixed;bottom:64px;left:16px;z-index:10001;
  display:flex;align-items:center;gap:6px;
  padding:5px 12px 5px 10px;
  border-radius:999px;
  background:rgba(8,13,18,0.82);
  backdrop-filter:blur(8px);
  border:1px solid rgba(123,255,171,0.25);
  box-shadow:0 2px 12px rgba(0,0,0,0.4);
  font:600 12px/1 system-ui,sans-serif;
  color:rgba(200,210,230,0.85);
  pointer-events:none;
  transition:opacity .4s;
}
#viewerCounter .vc-dot{
  width:7px;height:7px;border-radius:50%;
  background:#7bffab;
  box-shadow:0 0 6px rgba(123,255,171,0.6);
  animation:vc-pulse 2s ease-in-out infinite;
}
@keyframes vc-pulse{
  0%,100%{opacity:1;transform:scale(1)}
  50%{opacity:.5;transform:scale(.75)}
}
#viewerCounter .vc-num{
  font-variant-numeric:tabular-nums;
  color:#7bffab;
  font-weight:700;
}
@media(max-width:640px){
  #viewerCounter{bottom:56px;left:12px;padding:4px 10px 4px 8px;font-size:11px;gap:5px}
  #viewerCounter .vc-dot{width:6px;height:6px}
}
@media(max-width:480px){
  #viewerCounter{bottom:52px;left:12px}
}

@media(max-width:480px){
  #changelogBtn{width:36px;height:36px;font-size:14px;bottom:12px;left:12px}
  #changelogModal{max-height:90vh;border-radius:12px}
  #changelogModal .cl-header{padding:16px 16px 12px}
  #changelogModal .cl-header h2{font-size:15px}
  #changelogModal .cl-body{padding:6px 16px 20px}
  .cl-item{padding:6px 10px}
  .cl-item-title{font-size:12px}
  .cl-item-desc{font-size:11px}
}
  </style>
</head>
<body>

<!-- –ó–∞–≥–ª—É—à–∫–∞: –∫–∞—Ä—Ç–∞ –≤–∏–º–∫–Ω–µ–Ω–∞ -->
<div id="streamOffline">
  <div class="offline-icon">üì°</div>
  <h1>–ö–∞—Ä—Ç—É –∑–∞—Ä–∞–∑ –≤–∏–º–∫–Ω–µ–Ω–æ</h1>
  <p>–ö–∞—Ä—Ç–∞ –ø—Ä–∞—Ü—é—î –≤ —Ä—É—á–Ω–æ–º—É —Ä–µ–∂–∏–º—ñ ‚Äî —Ü—ñ–ª—ñ –≤–Ω–æ—Å—è—Ç—å—Å—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º –≤—Ä—É—á–Ω—É. –¢–æ–º—É —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—è –¥–æ—Å—Ç—É–ø–Ω–∞ –ª–∏—à–µ —Ç–æ–¥—ñ, –∫–æ–ª–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä –º–∞—î –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –≤–µ—Å—Ç–∏ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥.</p>
</div>

<button id="recenterBtn" class="recenter-btn" title="–¶–µ–Ω—Ç—Ä—É–≤–∞—Ç–∏ –Ω–∞ —Ü—ñ–ª—è—Ö"></button>

<div id="map">
  <div id="statusBar">‚è± --:-- ‚Ä¢ —Ü—ñ–ª–µ–π 0</div>
</div>
<div id="newTargetToast"></div>

<div id="basemapSwitcher" class="basemap-switcher"></div>

<script>
/* ===================== –ö–û–ù–§–Ü–ì ===================== */
const DEFAULT_CONFIG = {
  BASE_URL: (location.origin && location.origin !== 'null') ? location.origin : 'http://139.28.36.16:8000',
  AUTH_URL: '/auth/login',
  TARGETS_REST: '/targets',
  CLIENT_WATERMARK: true,
  WATERMARK_TEXT: '@SkyKh_info',
  WM_FONT_ABS: 0.028,
  WM_LOGO_PATH: 'Logo_SkyKh.jpg',
  ICON_SCALE_BY_ZOOM: [[10,1.0],[12,1.2],[14,1.4],[16,1.65]],
  ADMIN_PANEL_URL: 'https://admin.skykharkiv.online',
};
const APP_CONFIG = Object.assign({}, DEFAULT_CONFIG, (window.APP_CONFIG || {}));

/* ===== resolveIconUrl ===== */
const resolveIconUrl = (p) => {
  if (!p) return p;
  if (/^https?:\/\//i.test(p)) return p;
  const base = (APP_CONFIG.BASE_URL || location.origin || '').replace(/\/$/, '');
  const path = p.startsWith('/') ? p : `/${p}`;
  return base ? (base + path) : path;
};

/* ===== –£—Ç–∏–ª—ñ—Ç–∏ ===== */
const pad2 = n => String(n).padStart(2, '0');

/* ===== –Ü–∫–æ–Ω–∫–∏ ===== */
let ICON_PATHS = {
  shahed: 'shahed.png', shaheds: 'shaheds.png', gerbera: 'gerbera.PNG',
  orlan: 'orlan.png', lancet: 'lancet.png', zala: 'zala.png',
  supercam: 'supercam.png', molniya: 'molniya.png',
  rocket: 'rocket.png', kab: 'kab.png', explosion: 'Explosion.png',
  rszo: 'rszo.png', balistika: 'balistika.png'
};

async function loadIconsFromAdmin() {
  try {
    const base = (location.origin || '').replace(/\/$/, '');
    const resp = await fetch(base + '/api/icons', { cache: 'no-store' });
    if (!resp.ok) return;
    const data = await resp.json();
    const icons = data.icons || {};
    if (!Object.keys(icons).length) return;
    Object.entries(icons).forEach(([key, cfg]) => {
      let path = cfg.path || cfg.file;
      if (path) {
        if (path.startsWith('/static/icons/') || path.startsWith('static/icons/')) {
          ICON_PATHS[key] = base + (path.startsWith('/') ? path : '/' + path);
        } else if (/^https?:\/\//i.test(path)) {
          ICON_PATHS[key] = path;
        } else {
          ICON_PATHS[key] = path;
        }
      }
    });
  } catch (e) {
    console.warn('[Icons] Failed to load from admin:', e.message);
  }
}

/* ===== –¢–∏–ø–∏ —Ü—ñ–ª–µ–π ===== */
const TYPES = [
  ['shahed',28,45], ['gerbera',50,45], ['orlan',36,45], ['molniya',36,45], ['lancet',36,45],
  ['kab',30,180], ['rocket',30,45], ['–Ω–µ–≤—ñ–¥–æ–º–∏–π',36,0],
  ['explosion',60,0], ['rszo',80,45], ['balistika',80,45]
];
const LABELS = {
  shahed:'–®–∞—Ö–µ–¥', orlan:'–†–æ–∑–≤—ñ–¥. –ë–ø–õ–ê', molniya:'–ú–æ–ª–Ω—ñ—è', lancet:'–õ–∞–Ω—Ü–µ—Ç',
  kab:'–ö–ê–ë', rocket:'–†–∞–∫–µ—Ç–∞', '–Ω–µ–≤—ñ–¥–æ–º–∏–π':'–ù–µ–≤—ñ–¥–æ–º–∏–π', gerbera:'–ì–µ—Ä–±–µ—Ä–∞',
  explosion:'–í–∏–±—É—Ö / —É—Ä–∞–∂–µ–Ω–Ω—è', rszo:'–†–°–ó–û', balistika:'–ë–∞–ª—ñ—Å—Ç–∏–∫–∞'
};
const SHORT = {
  shahed:'–®–∞—Ö–µ–¥—ñ–≤:', orlan:'–†–æ–∑–≤—ñ–¥.:', molniya:'–ú–æ–ª–Ω—ñ–π:', lancet:'–õ–∞–Ω—Ü–µ—Ç—ñ–≤:',
  kab:'–ö–ê–ë—ñ–≤:', rocket:'–†–∞–∫–µ—Ç:', '–Ω–µ–≤—ñ–¥–æ–º–∏–π':'–ù–µ–≤—ñ–¥.:', gerbera:'–ì–µ—Ä–±–µ—Ä:',
  explosion:'–í–∏–±—É—Ö—ñ–≤:', rszo:'–†–°–ó–û:', balistika:'–ë–∞–ª—ñ—Å—Ç.:'
};

/* ===== –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ ===== */
let map, drones = [], markersGroup = null, targetsById = {};
let currentBaseMeta = { name: 'Google –†–µ–ª—å—î—Ñ', isDark: false };
let currentBaseLayer = null, currentBaseIdx = 0;
window.allTargets = [];

/* ===== –í—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –Ω–æ–≤–∏—Ö —Ü—ñ–ª–µ–π –ø–æ–∑–∞ –µ–∫—Ä–∞–Ω–æ–º ===== */
let _knownTargetIds = new Set();
let _toastTimer = null;

function showNewTargetToast(count, typeSummary) {
  const el = document.getElementById('newTargetToast');
  if (!el) return;
  el.textContent = `+${count} ${count === 1 ? '–Ω–æ–≤–∞ —Ü—ñ–ª—å' : (count < 5 ? '–Ω–æ–≤–∏—Ö —Ü—ñ–ª—ñ' : '–Ω–æ–≤–∏—Ö —Ü—ñ–ª–µ–π')}${typeSummary ? ' ‚Ä¢ ' + typeSummary : ''} ‚Üó`;
  el.classList.add('show');
  if (_toastTimer) clearTimeout(_toastTimer);
  _toastTimer = setTimeout(() => { el.classList.remove('show'); }, 4500);
}

function hideNewTargetToast() {
  const el = document.getElementById('newTargetToast');
  if (el) el.classList.remove('show');
  if (_toastTimer) { clearTimeout(_toastTimer); _toastTimer = null; }
}

/* ===== –ë–∞–∑–æ–≤—ñ —à–∞—Ä–∏ ===== */
const googleTerrain = L.tileLayer('https://mt1.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', { maxZoom: 19, attribution: '¬© Google' });
const googleRoads = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { maxZoom: 19, attribution: '¬© Google' });
const googleHybrid = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { maxZoom: 19, attribution: '¬© Google' });
const cartoPositron = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 19, attribution: '¬© CARTO' });
const cartoDark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19, attribution: '¬© CARTO' });
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '¬© OSM' });

const BASE_LAYERS = [
  { name: 'Google –†–µ–ª—å—î—Ñ', layer: googleTerrain, isDark: false },
  { name: 'Google –î–æ—Ä–æ–≥–∏', layer: googleRoads, isDark: false },
  { name: 'Google –ì—ñ–±—Ä–∏–¥', layer: googleHybrid, isDark: true },
  { name: 'CARTO –°–≤—ñ—Ç–ª–∞', layer: cartoPositron, isDark: false },
  { name: 'CARTO –¢–µ–º–Ω–∞', layer: cartoDark, isDark: true },
  { name: 'OSM –°—Ç–∞–Ω–¥–∞—Ä—Ç', layer: osm, isDark: false }
];

const canvasRenderer = L.canvas({ padding: 0.5 });

/* ===== –ê–Ω—ñ–º–∞—Ü—ñ—è (rAF) ===== */
const anims = new Set();
let sectorPulsePhase = 0;
const ANIM_MS = 14000;
function startAnimFor(d, A, B) { d._animData = { A, B, started: performance.now() }; anims.add(d); }
function stopAnimFor(d) { anims.delete(d); d._animData = null; }
function tick() {
  const now = performance.now();
  for (const d of anims) {
    const { A, B, started } = d._animData || {};
    if (!A || !B) continue;
    const p = ((now - started) % ANIM_MS) / ANIM_MS;
    d.marker.setLatLng([A.lat + (B.lat - A.lat) * p, A.lng + (B.lng - A.lng) * p]);
  }
  requestAnimationFrame(tick);
}

/* ===== –ì–µ–æ—É—Ç–∏–ª—ñ—Ç–∏ ===== */
function scaleForZoom(z) {
  const table = APP_CONFIG.ICON_SCALE_BY_ZOOM || [];
  let mult = 1;
  for (const [zz, m] of table) { if (z >= zz) mult = m; }
  if (currentBaseMeta.isDark) mult *= 1.08;
  return mult;
}

function sectorRadiusByZoom(baseRadius, baseZoom = 10) {
  return baseRadius * Math.pow(1.7, baseZoom - map.getZoom());
}

function icon(name, size) {
  const s = Math.round((size || 36) * scaleForZoom(map.getZoom()));
  const url = resolveIconUrl(ICON_PATHS[name] || `${name}.png`);
  return L.icon({ iconUrl: url, iconSize: [s, s], iconAnchor: [s / 2, s / 2] });
}

function refreshIconsByZoom() {
  const z = map.getZoom();
  drones.forEach(d => {
    if (!d) return;
    d.marker.setIcon(icon(d.iconT || d.type || 'shahed', d.baseSize || 36));
    if (d.ring) d.ring.setRadius((d.baseSize || 36) * scaleForZoom(z) * 0.32);
  });
}

function bearing(a, b) {
  const r = Math.PI / 180, dŒª = (b.lng - a.lng) * r;
  const y = Math.sin(dŒª) * Math.cos(b.lat * r);
  const x = Math.cos(a.lat * r) * Math.sin(b.lat * r) - Math.sin(a.lat * r) * Math.cos(b.lat * r) * Math.cos(dŒª);
  return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
}

function dest(pt, brg, dist) {
  const R = 6371000, Œ¥ = dist / R, Œ∏ = brg * Math.PI / 180;
  const œÜ1 = pt.lat * Math.PI / 180, Œª1 = pt.lng * Math.PI / 180;
  const œÜ2 = Math.asin(Math.sin(œÜ1) * Math.cos(Œ¥) + Math.cos(œÜ1) * Math.sin(Œ¥) * Math.cos(Œ∏));
  const Œª2 = Œª1 + Math.atan2(Math.sin(Œ∏) * Math.sin(Œ¥) * Math.cos(œÜ1), Math.cos(Œ¥) - Math.sin(œÜ1) * Math.cos(œÜ2));
  return L.latLng(œÜ2 * 180 / Math.PI, (Œª2 * 180 / Math.PI + 540) % 360 - 180);
}

function getEndpoint(lat, lon, bearingDeg, distKm = 15) {
  const R = 6371, ad = distKm / R;
  const la1 = lat * Math.PI / 180, lo1 = lon * Math.PI / 180, br = bearingDeg * Math.PI / 180;
  const la2 = Math.asin(Math.sin(la1) * Math.cos(ad) + Math.cos(la1) * Math.sin(ad) * Math.cos(br));
  const lo2 = lo1 + Math.atan2(Math.sin(br) * Math.sin(ad) * Math.cos(la1), Math.cos(ad) - Math.sin(la1) * Math.sin(la2));
  return [la2 * 180 / Math.PI, lo2 * 180 / Math.PI];
}

/* ===== –†–°–ó–û: –ø—ñ–¥–ø–∏—Å + —Å–µ–∫—Ç–æ—Ä ===== */
function ensureRszoLabel(d) {
  if (!d || d.type !== 'rszo') return;
  const brg = (typeof d.lastBearing === 'number') ? d.lastBearing : 0;
  const side = (brg >= 0 && brg <= 180) ? 'left' : 'right';
  const offset = (side === 'left') ? L.point(-26, 0) : L.point(26, 0);
  const txt = (typeof d.lastBearing === 'number') ? `–†–°–ó–û ‚Ä¢ ${Math.round(d.lastBearing)}¬∞` : '–†–°–ó–û';
  const opts = { permanent: true, interactive: false, className: 'rszo-tag', direction: side, offset, opacity: 0.95 };
  if (!d.rszoLabel) {
    d.rszoLabel = L.tooltip(opts).setContent(txt);
    d.marker.bindTooltip(d.rszoLabel).openTooltip();
  } else {
    d.rszoLabel.setContent(txt);
    d.rszoLabel.options.direction = side;
    d.rszoLabel.options.offset = offset;
    d.marker.unbindTooltip();
    d.marker.bindTooltip(d.rszoLabel).openTooltip();
  }
}

function buildSectorLatLngs(center, bearingDeg, radiusMeters, halfAngleDeg, steps = 28) {
  const pts = [center];
  const start = bearingDeg - halfAngleDeg, end = bearingDeg + halfAngleDeg;
  for (let i = 0; i <= steps; i++) pts.push(dest(center, start + (end - start) * (i / steps), radiusMeters));
  pts.push(center);
  return pts;
}

function drawSectorZone(d) {
  if (!d.sectorCfg) return;
  const cfg = d.sectorCfg, center = d.marker.getLatLng();
  const radius = sectorRadiusByZoom(cfg.baseRadius, cfg.baseZoom);
  if (d.zoneLayer) map.removeLayer(d.zoneLayer);
  const leftPt = dest(center, cfg.bearing - cfg.halfA, radius);
  const rightPt = dest(center, cfg.bearing + cfg.halfA, radius);
  d.zoneLayer = L.layerGroup([
    L.polyline([center, leftPt], { renderer: canvasRenderer, color: '#ff0033', weight: 2, opacity: 0.7, interactive: false }),
    L.polyline([center, rightPt], { renderer: canvasRenderer, color: '#ff0033', weight: 2, opacity: 0.7, interactive: false })
  ]).addTo(map);
}

function redrawAllSectors() { drones.forEach(d => { if (d?.sectorCfg) drawSectorZone(d); }); }
function pulseSectors() {
  sectorPulsePhase += 0.04;
  const a = 0.45 + Math.sin(sectorPulsePhase) * 0.25;
  drones.forEach(d => { if (d?.zoneLayer) d.zoneLayer.eachLayer(l => { if (l instanceof L.Polyline) l.setStyle({ opacity: a }); }); });
  requestAnimationFrame(pulseSectors);
}

/* ===== –í—ñ–∑—É–∞–ª ===== */
function recolorLabels() {
  const dark = currentBaseMeta.isDark;
  document.querySelectorAll('.drone-label').forEach(t => t.classList.toggle('light', !dark));
}
function recolorRoutes() {}

/* ===== –°—Ç–∞—Ç—É—Å-–±–∞—Ä ===== */
function buildAutoCaption() {
  const counts = {};
  drones.forEach(d => { if (d) counts[d.type] = (counts[d.type] || 0) + 1; });
  const total = Object.values(counts).reduce((a, b) => a + b, 0);
  if (!total) return '';
  return `–¶—ñ–ª–µ–π ${total}: ` + Object.entries(counts).map(([t, q]) => `${SHORT[t] || t} ${q}`).join(' | ');
}

function updateStatus() {
  const now = new Date();
  const text = `‚è± ${pad2(now.getHours())}:${pad2(now.getMinutes())} ‚Ä¢ ${buildAutoCaption() || '–¶—ñ–ª–µ–π 0'}`;
  const el = document.getElementById('statusBar');
  if (el) el.textContent = text;
}

/* ===== –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ü—ñ–ª–µ–π –∑ —Å–µ—Ä–≤–µ—Ä–∞ ===== */
function updateMapData(data) {
  if (!map) return;
  const items = Array.isArray(data?.items) ? data.items : (Array.isArray(data) ? data : []);
  window.allTargets = items;

  const seen = new Set();
  items.forEach(item => {
    const lat = parseFloat(item.lat), lon = parseFloat(item.lon);
    if (!Number.isFinite(lat) || !Number.isFinite(lon)) return;

    const id = item.id || `${item.type || 't'}:${lat},${lon}`;
    seen.add(id);

    const t = item.type || "shahed";
    const meta = TYPES.find(x => x[0] === t);
    const size = meta?.[1] || 36, rotOffset = meta?.[2] ?? 45;
    const icn = icon(t, size);

    // Bearing
    let brg = null;
    if (typeof item.bearing === 'number') brg = item.bearing;
    else if (typeof item.course === 'number') brg = item.course;
    else if (typeof item.angle === 'number') brg = item.angle;
    else if (item.vector) {
      let vx, vy;
      if (Array.isArray(item.vector) && item.vector.length >= 2) { vx = parseFloat(item.vector[0]); vy = parseFloat(item.vector[1]); }
      else if (typeof item.vector === 'object') { vx = parseFloat(item.vector.x ?? item.vector.dx); vy = parseFloat(item.vector.y ?? item.vector.dy); }
      if (Number.isFinite(vx) && Number.isFinite(vy)) brg = (Math.atan2(vx, vy) * 180 / Math.PI + 360) % 360;
    }

    let d = targetsById[id];

    if (!d) {
      // –ù–æ–≤–∏–π –º–∞—Ä–∫–µ—Ä
      let marker;
      if (typeof L.rotatedMarker === 'function') {
        marker = L.rotatedMarker([lat, lon], { icon: icn, rotationAngle: brg !== null ? (brg - rotOffset) : 0, rotationOrigin: 'center', pane: 'targetsPane' });
      } else {
        marker = L.marker([lat, lon], { icon: icn, pane: 'targetsPane', rotationOrigin: 'center center' });
      }
      if (markersGroup) markersGroup.addLayer(marker); else marker.addTo(map);

      const shadow = L.polyline([], { color: '#000', weight: 4, opacity: 0.25, interactive: false, lineCap: 'round', lineJoin: 'round' }).addTo(markersGroup || map);
      const line = L.polyline([], { color: '#ff2a2a', weight: 1.4, opacity: 0.9, interactive: false, lineCap: 'butt', lineJoin: 'round' }).addTo(markersGroup || map);

      // –ü–æ–ø–∞–ø –∑ –Ω–∞–∑–≤–æ—é —Ü—ñ–ª—ñ —Ç–∞ –æ–ø–∏—Å–æ–º –ø—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ
      const label = LABELS[t] || t;
      const desc = item.description || '';
      const popupHtml = desc ? `<b>${label}</b><div style="margin-top:4px;font-weight:400;opacity:0.85">${desc}</div>` : `<b>${label}</b>`;
      marker.bindPopup(popupHtml, { closeButton: false, className: 'target-popup', offset: [0, -8] });

      d = { id, type: t, iconT: t, baseSize: size, rotOffset, marker, shadow, line, lastBearing: brg, courseLine: null, points: [L.latLng(lat, lon)], description: desc };
      targetsById[id] = d;
      drones.push(d);
    } else {
      // –û–Ω–æ–≤–ª–µ–Ω–Ω—è
      const newPt = L.latLng(lat, lon);
      d.marker.setLatLng(newPt);
      d.points.push(newPt);
      if (d.line) d.line.setLatLngs(d.points);
      if (d.shadow) d.shadow.setLatLngs(d.points);
      if (brg !== null && d.type !== 'rszo') d.marker.setRotationAngle?.(brg - d.rotOffset);
      const typeChanged = d.type !== t;
      if (typeChanged) { d.marker.setIcon(icn); d.type = t; d.iconT = t; d.baseSize = size; d.rotOffset = rotOffset; }
      // –û–Ω–æ–≤–ª—é—î–º–æ –æ–ø–∏—Å —ñ –ø–æ–ø–∞–ø
      const newDesc = item.description || '';
      if (newDesc !== d.description || typeChanged) {
        d.description = newDesc;
        const lbl = LABELS[d.type] || d.type;
        d.marker.setPopupContent(newDesc ? `<b>${lbl}</b><div style="margin-top:4px;font-weight:400;opacity:0.85">${newDesc}</div>` : `<b>${lbl}</b>`);
      }
      d.lastBearing = brg;
    }

    // –†–°–ó–û: —Å–µ–∫—Ç–æ—Ä (–ª—ñ–Ω—ñ—ó) ‚Äî —è–∫—â–æ —î bearing
    if (d.type === 'rszo' && brg !== null) {
      d.sectorCfg = { baseRadius: 14000, baseZoom: 10, halfA: 18, bearing: brg };
      drawSectorZone(d);
      ensureRszoLabel(d);
    }

    // –õ—ñ–Ω—ñ—è –∫—É—Ä—Å—É (–∑–µ–ª–µ–Ω–∞ –ø—É–Ω–∫—Ç–∏—Ä–Ω–∞) ‚Äî –¥–ª—è –ù–ï-–†–°–ó–û —Ü—ñ–ª–µ–π
    if (d.courseLine) { map.removeLayer(d.courseLine); d.courseLine = null; }
    let end = null;
    const ptA = L.latLng(lat, lon);
    if (item.vector) {
      if (Array.isArray(item.vector) && item.vector.length >= 2) { const vlat = parseFloat(item.vector[0]), vlon = parseFloat(item.vector[1]); if (Number.isFinite(vlat) && Number.isFinite(vlon)) end = [vlat, vlon]; }
      else if (typeof item.vector === 'object') { const vlat = parseFloat(item.vector.lat ?? item.vector.y ?? item.vector.dy), vlon = parseFloat(item.vector.lon ?? item.vector.x ?? item.vector.dx); if (Number.isFinite(vlat) && Number.isFinite(vlon)) end = [vlat, vlon]; }
    }
    if (!end && brg !== null) end = getEndpoint(lat, lon, brg, 15);
    if (end) d.courseLine = L.polyline([[lat, lon], [end[0], end[1]]], { color: '#79ff9a', weight: 2, dashArray: '5, 10', opacity: 0.6, interactive: false }).addTo(markersGroup || map);
  });

  // –í–∏–¥–∞–ª—è—î–º–æ –≤—ñ–¥—Å—É—Ç–Ω—ñ —Ü—ñ–ª—ñ
  Object.keys(targetsById).forEach(id => {
    if (seen.has(id)) return;
    const d = targetsById[id];
    [d?.marker, d?.shadow, d?.line, d?.courseLine, d?.zoneLayer, d?.rszoLabel].forEach(l => { if (l) { map.removeLayer(l); if (markersGroup) markersGroup.removeLayer(l); } });
    delete targetsById[id];
    drones = drones.filter(x => x && x.id !== id);
  });

  // –í–∏—è–≤–ª–µ–Ω–Ω—è –Ω–æ–≤–∏—Ö —Ü—ñ–ª–µ–π –ø–æ–∑–∞ –≤–∏–¥–∏–º–æ—é –æ–±–ª–∞—Å—Ç—é
  if (_knownTargetIds.size > 0) {
    const bounds = map.getBounds();
    const newOutside = [];
    for (const item of items) {
      const lat = parseFloat(item.lat), lon = parseFloat(item.lon);
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) continue;
      const id = item.id || `${item.type || 't'}:${lat},${lon}`;
      if (!_knownTargetIds.has(id) && !bounds.contains([lat, lon])) {
        newOutside.push(item.type || 'shahed');
      }
    }
    if (newOutside.length > 0) {
      const typeCounts = {};
      newOutside.forEach(t => { typeCounts[t] = (typeCounts[t] || 0) + 1; });
      const summary = Object.entries(typeCounts).map(([t, q]) => `${LABELS[t] || t} ${q}`).join(', ');
      showNewTargetToast(newOutside.length, summary);
    }
  }
  // –û–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–æ–º—ñ ID
  _knownTargetIds = new Set(seen);

  updateStatus();
}

function recenterTargets() {
  const items = Array.isArray(window.allTargets) ? window.allTargets : [];
  if (items.length) {
    const coords = items.map(it => [parseFloat(it.lat), parseFloat(it.lon)]).filter(p => Number.isFinite(p[0]) && Number.isFinite(p[1]));
    coords.push([49.9935, 36.2304]);
    if (coords.length) { map.flyToBounds(coords, { padding: [50, 50], maxZoom: 12 }); return; }
  }
  map.flyTo([49.9935, 36.2304], 11);
}

/* ===== –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–∞—Ä—Ç–∏ ===== */
function initApp() {
  if (window.mapInitialized) return;
  window.mapInitialized = true;

  map = L.map('map', { center: [49.9, 36.3], zoom: 10, preferCanvas: true, zoomControl: false });
  map.createPane('targetsPane');
  map.getPane('targetsPane').style.zIndex = 650;
  markersGroup = L.featureGroup({ pane: 'targetsPane' }).addTo(map);

  // –ü–æ—á–∞—Ç–∫–æ–≤–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ü—ñ–ª–µ–π
  setTimeout(async () => {
    try {
      const resp = await fetch('/targets');
      const data = await resp.json();
      if (typeof updateMapData === 'function') updateMapData(data);
    } catch (e) { console.error('Initial targets fetch failed:', e); }
  }, 500);

  BASE_LAYERS[0].layer.addTo(map);
  currentBaseLayer = BASE_LAYERS[0].layer;
  currentBaseIdx = 0;

  requestAnimationFrame(tick);
  requestAnimationFrame(pulseSectors);

  buildBasemapSwitcher();

  // –ö–Ω–æ–ø–∫–∞ –ø—ñ–¥–∫–ª–∞–¥–æ–∫
  const sw = document.getElementById('basemapSwitcher');
  if (sw) {
    const bmFab = sw.querySelector('.bm-fab');
    if (bmFab) bmFab.addEventListener('click', e => { e.stopPropagation(); sw.classList.toggle('open'); });
    document.addEventListener('click', e => { if (!sw.contains(e.target)) sw.classList.remove('open'); });
  }

  // –†–µ—Ü–µ–Ω—Ç—Ä
  const recenterBtn = document.getElementById('recenterBtn');
  if (recenterBtn) recenterBtn.onclick = () => recenterTargets();

  // –ù–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –Ω–∞ —Å—Ç–∞—Ç—É—Å-–±–∞—Ä ‚Üí –ø–æ–∫–∞–∑–∞—Ç–∏ –≤—Å—ñ —Ü—ñ–ª—ñ
  const statusBar = document.getElementById('statusBar');
  if (statusBar) statusBar.onclick = () => recenterTargets();

  // –ù–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –Ω–∞ toast ‚Üí –ø–æ–∫–∞–∑–∞—Ç–∏ –≤—Å—ñ —Ü—ñ–ª—ñ + —Å—Ö–æ–≤–∞—Ç–∏ toast
  const toast = document.getElementById('newTargetToast');
  if (toast) toast.onclick = () => { hideNewTargetToast(); recenterTargets(); };

  L.control.scale({ imperial: false, metric: true, maxWidth: 120 }).addTo(map);
  document.body.classList.toggle('dark-map', BASE_LAYERS[0].isDark);

  map.on('zoomend', () => { refreshIconsByZoom(); redrawAllSectors(); });
}

/* ===== –î–æ–∫ –ø—ñ–¥–∫–ª–∞–¥–æ–∫ ===== */
function buildBasemapSwitcher() {
  const sw = document.getElementById('basemapSwitcher');
  if (!sw) return;
  sw.innerHTML = '';

  const fab = document.createElement('button');
  fab.type = 'button'; fab.className = 'bm-fab'; fab.textContent = 'üó∫'; fab.title = '–ü—ñ–¥–∫–ª–∞–¥–∫–∞ –∫–∞—Ä—Ç–∏';
  sw.appendChild(fab);

  const panel = document.createElement('div');
  panel.className = 'bm-panel';
  sw.appendChild(panel);

  const title = document.createElement('div');
  title.className = 'bm-title'; title.textContent = '–ü—ñ–¥–∫–ª–∞–¥–∫–∞ –∫–∞—Ä—Ç–∏';
  panel.appendChild(title);

  const list = document.createElement('div');
  list.className = 'bm-list';
  panel.appendChild(list);

  BASE_LAYERS.forEach((meta, idx) => {
    const btn = document.createElement('button');
    btn.className = 'bm-item'; btn.dataset.idx = String(idx);
    btn.innerHTML = `<div class="bm-name">${meta.name}</div><div class="bm-sub">${meta.isDark ? '—Ç–µ–º–Ω–∞' : '—Å–≤—ñ—Ç–ª–∞'}</div>`;
    if (idx === 0) btn.classList.add('active');
    list.appendChild(btn);
  });

  list.addEventListener('click', e => {
    const btn = e.target.closest('.bm-item');
    if (!btn) return;
    const idx = parseInt(btn.dataset.idx, 10);
    const meta = BASE_LAYERS[idx];
    if (!meta || meta.layer === currentBaseLayer) return;
    if (currentBaseLayer && map.hasLayer(currentBaseLayer)) map.removeLayer(currentBaseLayer);
    meta.layer.addTo(map);
    currentBaseLayer = meta.layer; currentBaseIdx = idx;
    list.querySelectorAll('.bm-item').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentBaseMeta = { name: meta.name, isDark: meta.isDark };
    document.body.classList.toggle('dark-map', meta.isDark);
    recolorLabels(); recolorRoutes(); refreshIconsByZoom(); redrawAllSectors();
  });
}

/* ===== –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—ó ===== */
let streamActive = true;
const ADMIN_BASE = location.origin || '';

async function checkStreamStatus() {
  try {
    const resp = await fetch(ADMIN_BASE.replace(/\/$/, '') + '/api/stream/status', { cache: 'no-store' });
    if (!resp.ok) return; // –ø—Ä–∏ –æ—à–∏–±–∫–µ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º
    const data = await resp.json();
    streamActive = !!data.active;
  } catch (e) {
    // –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å–µ—Ç–∏ ‚Äî –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É
    streamActive = true;
  }
  const overlay = document.getElementById('streamOffline');
  if (overlay) overlay.classList.toggle('visible', !streamActive);
}

/* ===== –ó–∞–ø—É—Å–∫ ===== */
(async () => {
  await checkStreamStatus();
  if (streamActive) {
    await loadIconsFromAdmin();
    initApp();
  }
  // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞—Ç—É—Å –∫–æ–∂–Ω—ñ 15 —Å–µ–∫—É–Ω–¥
  setInterval(async () => {
    const wasBefore = streamActive;
    await checkStreamStatus();
    // –Ø–∫—â–æ —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—é —â–æ–π–Ω–æ —É–≤—ñ–º–∫–Ω—É–ª–∏ ‚Äî —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –∫–∞—Ä—Ç—É
    if (streamActive && !wasBefore) {
      await loadIconsFromAdmin();
      initApp();
    }
  }, 15000);
})();
</script>

<!-- ===== CHANGELOG BUTTON + MODAL ===== -->
<a id="donateBtn" href="https://send.monobank.ua/jar/7nLEDMfuNF" target="_blank" rel="noopener" title="–ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–æ—î–∫—Ç">
  <span class="donate-icon">ü´ô</span>
  <span class="donate-label">–î–æ–Ω–∞—Ç</span>
</a>
<a id="donateToast" href="https://send.monobank.ua/jar/7nLEDMfuNF" target="_blank" rel="noopener">
  <span class="dt-icon">‚ù§Ô∏è</span>
  <span class="dt-text">–ü—ñ–¥—Ç—Ä–∏–º–∞–π—Ç–µ –ø—Ä–æ—î–∫—Ç</span>
  <span class="dt-close" onclick="event.preventDefault();event.stopPropagation();closeDonateToast()">‚úï</span>
</a>

<div id="viewerCounter"><span class="vc-dot"></span><span class="vc-num">‚Äî</span><span class="vc-label">–æ–Ω–ª–∞–π–Ω</span></div>

<button id="changelogBtn" title="–û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ—î–∫—Ç—É">üîÑ</button>

<div id="changelogOverlay">
  <div id="changelogModal">
    <div class="cl-header">
      <h2>üìã –ñ—É—Ä–Ω–∞–ª –æ–Ω–æ–≤–ª–µ–Ω—å</h2>
      <button class="cl-close" id="clClose">&times;</button>
    </div>
    <div class="cl-body">

      <div class="cl-group">
        <div class="cl-group-title">üó∫Ô∏è –ö–∞—Ä—Ç–∞</div>
        <div class="cl-item"><div class="cl-item-title">–Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞ –∫–∞—Ä—Ç–∞ –∑–∞–≥—Ä–æ–∑</div><div class="cl-item-desc">–ü–æ–≤–Ω–æ—Ü—ñ–Ω–Ω–∞ –æ–Ω–ª–∞–π–Ω-–∫–∞—Ä—Ç–∞ –∑ —Ü–µ–Ω—Ç—Ä–æ–º –Ω–∞ –•–∞—Ä–∫–æ–≤—ñ –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –ø–æ–≤—ñ—Ç—Ä—è–Ω–∏—Ö –∑–∞–≥—Ä–æ–∑ —É —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ</div></div>
        <div class="cl-item"><div class="cl-item-title">–í–∏–±—ñ—Ä –ø—ñ–¥–∫–ª–∞–¥–∫–∏</div><div class="cl-item-desc">6 –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–∞—Ä—Ç–∏ ‚Äî —Å—É–ø—É—Ç–Ω–∏–∫–æ–≤–∞, –¥–æ—Ä–æ–∂–Ω—è, —Ä–µ–ª—å—î—Ñ–Ω–∞ —Ç–∞ —ñ–Ω—à—ñ, –∑ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—é –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è</div></div>
        <div class="cl-item"><div class="cl-item-title">–°—Ç–∏–ª—ñ–∑–æ–≤–∞–Ω–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å</div><div class="cl-item-desc">–°—É—á–∞—Å–Ω–∏–π —Ç–∞–∫—Ç–∏—á–Ω–∏–π –¥–∏–∑–∞–π–Ω –∑ —Ç–µ–º–Ω–æ—é —Ç–µ–º–æ—é, –∑—Ä—É—á–Ω–∏–π –¥–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤–¥–µ–Ω—å —Ç–∞ –≤–Ω–æ—á—ñ</div></div>
      </div>

      <div class="cl-group">
        <div class="cl-group-title">üéØ –í—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –∑–∞–≥—Ä–æ–∑</div>
        <div class="cl-item"><div class="cl-item-title">11 —Ç–∏–ø—ñ–≤ —Ü—ñ–ª–µ–π</div><div class="cl-item-desc">–®–∞—Ö–µ–¥–∏, —Ä–∞–∫–µ—Ç–∏, –ö–ê–ë–∏, –†–°–ó–û, –±–∞–ª—ñ—Å—Ç–∏–∫–∞, —Ä–æ–∑–≤—ñ–¥—É–≤–∞–ª—å–Ω—ñ –¥—Ä–æ–Ω–∏ —Ç–∞ —ñ–Ω—à—ñ ‚Äî –∫–æ–∂–µ–Ω —Ç–∏–ø —ñ–∑ –≤–ª–∞—Å–Ω–æ—é —ñ–∫–æ–Ω–∫–æ—é</div></div>
        <div class="cl-item"><div class="cl-item-title">–ü–æ–∑–Ω–∞—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç—ñ</div><div class="cl-item-desc">–ö–æ–∂–Ω–∞ —Ü—ñ–ª—å –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è —ñ–∫–æ–Ω–∫–æ—é –∑ –Ω–∞–ø—Ä—è–º–∫–æ–º —Ä—É—Ö—É —Ç–∞ –ø—ñ–¥—Å–≤—ñ—Ç–∫–æ—é –¥–ª—è –∫—Ä–∞—â–æ—ó –≤–∏–¥–∏–º–æ—Å—Ç—ñ</div></div>
        <div class="cl-item"><div class="cl-item-title">–ó—Ä—É—á–Ω–µ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è</div><div class="cl-item-desc">–Ü–∫–æ–Ω–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–º—ñ–Ω—é—é—Ç—å —Ä–æ–∑–º—ñ—Ä –ø—Ä–∏ –Ω–∞–±–ª–∏–∂–µ–Ω–Ω—ñ —Ç–∞ –≤—ñ–¥–¥–∞–ª–µ–Ω–Ω—ñ –∫–∞—Ä—Ç–∏</div></div>
      </div>

      <div class="cl-group">
        <div class="cl-group-title">üìç –ú–∞—Ä—à—Ä—É—Ç–∏</div>
        <div class="cl-item"><div class="cl-item-title">–í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É</div><div class="cl-item-desc">–í–∏–¥–Ω–æ —à–ª—è—Ö, —è–∫–∏–º —Ä—É—Ö–∞–ª–∞—Å—è —Ü—ñ–ª—å ‚Äî —Ü–µ –¥–æ–ø–æ–º–∞–≥–∞—î –∑—Ä–æ–∑—É–º—ñ—Ç–∏ –Ω–∞–ø—Ä—è–º–æ–∫ –∑–∞–≥—Ä–æ–∑–∏</div></div>
        <div class="cl-item"><div class="cl-item-title">–ü—Ä–æ–≥–Ω–æ–∑ —Ä—É—Ö—É</div><div class="cl-item-desc">–ß–µ—Ä–≤–æ–Ω–∞ –ø—É–Ω–∫—Ç–∏—Ä–Ω–∞ –ª—ñ–Ω—ñ—è –ø–æ–∫–∞–∑—É—î –π–º–æ–≤—ñ—Ä–Ω–∏–π –ø–æ–¥–∞–ª—å—à–∏–π –Ω–∞–ø—Ä—è–º–æ–∫ —Ü—ñ–ª—ñ</div></div>
        <div class="cl-item"><div class="cl-item-title">–í–µ–∫—Ç–æ—Ä –∫—É—Ä—Å—É</div><div class="cl-item-desc">–ó–µ–ª–µ–Ω–∞ –ª—ñ–Ω—ñ—è –≤–∫–∞–∑—É—î –∑–∞–≥–∞–ª—å–Ω–∏–π –Ω–∞–ø—Ä—è–º–æ–∫ —Ä—É—Ö—É –Ω–∞ –≤–µ–ª–∏–∫—ñ–π –≤—ñ–¥—Å—Ç–∞–Ω—ñ</div></div>
      </div>

      <div class="cl-group">
        <div class="cl-group-title">üéñÔ∏è –°–µ–∫—Ç–æ—Ä–∏ –∑–∞–≥—Ä–æ–∑–∏ –†–°–ó–û</div>
        <div class="cl-item"><div class="cl-item-title">–ó–æ–Ω–∞ —É—Ä–∞–∂–µ–Ω–Ω—è</div><div class="cl-item-desc">–î–ª—è –†–°–ó–û –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è —Å–µ–∫—Ç–æ—Ä –º–æ–∂–ª–∏–≤–æ–≥–æ —É—Ä–∞–∂–µ–Ω–Ω—è –∑ –∞–Ω—ñ–º–∞—Ü—ñ—î—é</div></div>
        <div class="cl-item"><div class="cl-item-title">–ù–∞–ø—Ä—è–º–æ–∫ –æ–±—Å—Ç—Ä—ñ–ª—É</div><div class="cl-item-desc">–û–ø–µ—Ä–∞—Ç–æ—Ä –∑–∞–¥–∞—î –Ω–∞–ø—Ä—è–º–æ–∫ ‚Äî –Ω–∞ –∫–∞—Ä—Ç—ñ –∑'—è–≤–ª—è—î—Ç—å—Å—è –∑–æ–Ω–∞ –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ—ó –∑–∞–≥—Ä–æ–∑–∏</div></div>
      </div>

      <div class="cl-group">
        <div class="cl-group-title">üñ•Ô∏è –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω–∞ –ø–∞–Ω–µ–ª—å</div>
        <div class="cl-item"><div class="cl-item-title">–°—Ç–∞—Ç—É—Å-–±–∞—Ä</div><div class="cl-item-desc">–ó–≤–µ—Ä—Ö—É –∫–∞—Ä—Ç–∏ –∑–∞–≤–∂–¥–∏ –≤–∏–¥–Ω–æ –ø–æ—Ç–æ—á–Ω–∏–π —á–∞—Å —Ç–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∏—Ö —Ü—ñ–ª–µ–π</div></div>
        <div class="cl-item"><div class="cl-item-title">–í–∏–±—ñ—Ä –≤–∏–≥–ª—è–¥—É –∫–∞—Ä—Ç–∏</div><div class="cl-item-desc">–ó—Ä—É—á–Ω–∞ –∫–Ω–æ–ø–∫–∞ –¥–ª—è —à–≤–∏–¥–∫–æ—ó –∑–º—ñ–Ω–∏ —Ç–∏–ø—É –ø—ñ–¥–∫–ª–∞–¥–∫–∏ –∫–∞—Ä—Ç–∏</div></div>
      </div>

      <div class="cl-group">
        <div class="cl-group-title">üíß –ó–∞—Ö–∏—Å—Ç –∫–æ–Ω—Ç–µ–Ω—Ç—É</div>
        <div class="cl-item"><div class="cl-item-title">–í–æ–¥—è–Ω–∏–π –∑–Ω–∞–∫</div><div class="cl-item-desc">–ù–∞ –≤—Å—ñ—Ö –∑–Ω—ñ–º–∫–∞—Ö –∑ –∫–∞—Ä—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑'—è–≤–ª—è—î—Ç—å—Å—è –≤–æ–¥—è–Ω–∏–π –∑–Ω–∞–∫ @SkyKh_info</div></div>
        <div class="cl-item"><div class="cl-item-title">–ì–Ω—É—á–∫–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</div><div class="cl-item-desc">–ó–æ–≤–Ω—ñ—à–Ω—ñ–π –≤–∏–≥–ª—è–¥ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</div></div>
      </div>

      <div class="cl-group">
        <div class="cl-group-title">üì° –¢—Ä–∞–Ω—Å–ª—è—Ü—ñ—è</div>
        <div class="cl-item"><div class="cl-item-title">–ö–∞—Ä—Ç–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ</div><div class="cl-item-desc">–î–∞–Ω—ñ –Ω–∞ –∫–∞—Ä—Ç—ñ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∫–æ–∂–Ω—ñ –∫—ñ–ª—å–∫–∞ —Å–µ–∫—É–Ω–¥ ‚Äî –≤–∏ –±–∞—á–∏—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—É —Å–∏—Ç—É–∞—Ü—ñ—é</div></div>
        <div class="cl-item"><div class="cl-item-title">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ —É–≤—ñ–º–∫–Ω–µ–Ω–Ω—è</div><div class="cl-item-desc">–ö–æ–ª–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä –∑–∞–ø—É—Å–∫–∞—î —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—é ‚Äî –∫–∞—Ä—Ç–∞ –∑'—è–≤–ª—è—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ, –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏</div></div>
        <div class="cl-item"><div class="cl-item-title">–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ —Å—Ç–∞—Ç—É—Å</div><div class="cl-item-desc">–ö–æ–ª–∏ —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—è –≤–∏–º–∫–Ω–µ–Ω–∞ ‚Äî –Ω–∞ –µ–∫—Ä–∞–Ω—ñ –∑'—è–≤–ª—è—î—Ç—å—Å—è –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</div></div>
      </div>

      <div class="cl-group">
        <div class="cl-group-title">ü§ñ Telegram-–±–æ—Ç</div>
        <div class="cl-item"><div class="cl-item-title">–ö–∞—Ä—Ç–∞ –ø—Ä—è–º–æ –≤ Telegram</div><div class="cl-item-desc">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –≤ –±–æ—Ç—ñ ‚Äî —ñ –∫–∞—Ä—Ç–∞ –≤—ñ–¥–∫—Ä–∏—î—Ç—å—Å—è –ø—Ä—è–º–æ —É –º–µ—Å–µ–Ω–¥–∂–µ—Ä—ñ, –±–µ–∑ –±—Ä–∞—É–∑–µ—Ä–∞</div></div>
        <div class="cl-item"><div class="cl-item-title">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥–ø–∏—Å–∫–∏</div><div class="cl-item-desc">–î–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É –∫–∞—Ä—Ç–∏ –ø–æ—Ç—Ä—ñ–±–Ω–æ –±—É—Ç–∏ –ø—ñ–¥–ø–∏—Å–Ω–∏–∫–æ–º –∫–∞–Ω–∞–ª—É @skykh_info</div></div>
        <div class="cl-item"><div class="cl-item-title">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ñ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è</div><div class="cl-item-desc">–ö–æ–º–∞–Ω–¥–∞ /notify ‚Äî –æ—Ç—Ä–∏–º—É–π—Ç–µ –æ—Å–æ–±–∏—Å—Ç–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —â–æ—Ä–∞–∑—É, –∫–æ–ª–∏ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∞–±–æ –∑–∞–≤–µ—Ä—à—É—î—Ç—å—Å—è —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—è</div></div>
        <div class="cl-item"><div class="cl-item-title">–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ü—ñ—ó</div><div class="cl-item-desc">–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∏ –º–æ–∂—É—Ç—å –Ω–∞–¥—Å–∏–ª–∞—Ç–∏ –≤–∞–∂–ª–∏–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—Å—ñ–º –ø—ñ–¥–ø–∏—Å–Ω–∏–∫–∞–º –±–æ—Ç–∞</div></div>
      </div>

      <div class="cl-group">
        <div class="cl-group-title">üîí –ë–µ–∑–ø–µ–∫–∞</div>
        <div class="cl-item"><div class="cl-item-title">–ó–∞—Ö–∏—â–µ–Ω–∏–π –¥–æ—Å—Ç—É–ø</div><div class="cl-item-desc">–í—Ö—ñ–¥ –Ω–∞ –∫–∞—Ä—Ç—É –∑–∞—Ö–∏—â–µ–Ω–∏–π –ø–∞—Ä–æ–ª–µ–º ‚Äî –¥–∞–Ω—ñ –ø–µ—Ä–µ–≤—ñ—Ä—è—é—Ç—å—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ</div></div>
        <div class="cl-item"><div class="cl-item-title">–ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫—ñ–≤</div><div class="cl-item-desc">–û–±–º–µ–∂–µ–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —Å–ø—Ä–æ–± –≤—Ö–æ–¥—É, —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –∑'—î–¥–Ω–∞–Ω–Ω—è —Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è –ø—ñ–¥–æ–∑—Ä—ñ–ª–æ—ó –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ</div></div>
      </div>

      <div class="cl-group">
        <div class="cl-group-title">üìã –Ü–Ω—à–µ</div>
        <div class="cl-item"><div class="cl-item-title">–ñ—É—Ä–Ω–∞–ª –æ–Ω–æ–≤–ª–µ–Ω—å</div><div class="cl-item-desc">–ö–Ω–æ–ø–∫–∞ üîÑ –Ω–∞ –∫–∞—Ä—Ç—ñ ‚Äî –∑–∞–≤–∂–¥–∏ –º–æ–∂–Ω–∞ –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏, —â–æ –Ω–æ–≤–æ–≥–æ –∑'—è–≤–∏–ª–æ—Å—è —É –ø—Ä–æ—î–∫—Ç—ñ</div></div>
        <div class="cl-item"><div class="cl-item-title">–ü–∞–Ω–µ–ª—å –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è</div><div class="cl-item-desc">–£—Å—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–∞—Ä—Ç–∏, –±–æ—Ç–∞ —Ç–∞ —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ–π –∫–µ—Ä—É—é—Ç—å—Å—è —á–µ—Ä–µ–∑ –∑—Ä—É—á–Ω—É –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é —Ç–µ–ª–µ—Ñ–æ–Ω—ñ–≤ —Ç–∞ –ø–ª–∞–Ω—à–µ—Ç—ñ–≤</div></div>
        <div class="cl-item"><div class="cl-item-title">–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Ç–∞ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è</div><div class="cl-item-desc">–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∏ –æ—Ç—Ä–∏–º—É—é—Ç—å –º–∏—Ç—Ç—î–≤—ñ Telegram-—Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è —è–∫—â–æ —â–æ—Å—å –ø—ñ—à–ª–æ –Ω–µ —Ç–∞–∫ –∑ —Ä–æ–±–æ—Ç–æ—é —Å–µ—Ä–≤—ñ—Å—É</div></div>
        <div class="cl-item"><div class="cl-item-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–∞ –≥—Ä–∞—Ñ—ñ–∫–∏</div><div class="cl-item-desc">–î–µ—Ç–∞–ª—å–Ω—ñ –≥—Ä–∞—Ñ—ñ–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –ø—Ä–æ—î–∫—Ç—É ‚Äî –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ–π, –∞–∫—Ç–∏–≤–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ —Ç–∞ —ñ–Ω—à–∏—Ö –ø–æ–¥—ñ–π</div></div>
      </div>

      <div class="cl-group">
        <div class="cl-group-title">üõ†Ô∏è –û–Ω–æ–≤–ª–µ–Ω–Ω—è 14.02.2026</div>
        <div class="cl-item"><div class="cl-item-title">–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –Ω–æ–≤—ñ —Ü—ñ–ª—ñ</div><div class="cl-item-desc">–ö–æ–ª–∏ –≤–∏ –∑—É–º–æ–≤–∞–Ω—ñ –Ω–∞ —á–∞—Å—Ç–∏–Ω—É –∫–∞—Ä—Ç–∏ ‚Äî –∑–≤–µ—Ä—Ö—É –∑'—è–≤–∏—Ç—å—Å—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –Ω–æ–≤—ñ —Ü—ñ–ª—ñ –∑–∞ –º–µ–∂–∞–º–∏ –µ–∫—Ä–∞–Ω—É –∑ —ó—Ö —Ç–∏–ø–∞–º–∏ —Ç–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—é</div></div>
        <div class="cl-item"><div class="cl-item-title">–ö–ª—ñ–∫–∞–±–µ–ª—å–Ω–∏–π –ª—ñ—á–∏–ª—å–Ω–∏–∫ —Ü—ñ–ª–µ–π</div><div class="cl-item-desc">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ —Å—Ç–∞—Ç—É—Å-–±–∞—Ä –∑–≤–µ—Ä—Ö—É –∫–∞—Ä—Ç–∏ ‚Äî –∫–∞–º–µ—Ä–∞ –ø–ª–∞–≤–Ω–æ –≤—ñ–¥–∑—É–º–∏—Ç—å—Å—è —ñ –ø–æ–∫–∞–∂–µ –≤—Å—ñ –∞–∫—Ç–∏–≤–Ω—ñ —Ü—ñ–ª—ñ</div></div>
        <div class="cl-item"><div class="cl-item-title">–°–∏—Å—Ç–µ–º–∞ –∑–≤–æ—Ä–æ—Ç–Ω–æ–≥–æ –∑–≤'—è–∑–∫—É</div><div class="cl-item-desc">–ù–æ–≤–∞ –∫–æ–º–∞–Ω–¥–∞ /feedback —É –±–æ—Ç—ñ —á–∞—Ç—É ‚Äî –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó, —Å–∫–∞—Ä–≥–∏ —Ç–∞ –±–∞–≥-—Ä–µ–ø–æ—Ä—Ç–∏ –Ω–∞–¥—Ö–æ–¥—è—Ç—å –ø—Ä—è–º–æ –≤ –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</div></div>
        <div class="cl-item"><div class="cl-item-title">–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –±—ñ–ª–æ—ó —Å–º—É–≥–∏</div><div class="cl-item-desc">–ù–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—è—Ö –±—ñ–ª—å—à–µ –Ω–µ –∑'—è–≤–ª—è—î—Ç—å—Å—è –±—ñ–ª–∞ —Å–º—É–≥–∞ –≤–Ω–∏–∑—É –∫–∞—Ä—Ç–∏ ‚Äî —Ñ–æ–Ω –∞–¥–∞–ø—Ç–æ–≤–∞–Ω–æ –ø—ñ–¥ –≤—Å—ñ —Ä–æ–∑–º—ñ—Ä–∏ –µ–∫—Ä–∞–Ω—É</div></div>
        <div class="cl-item"><div class="cl-item-title">–ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –ø—Ä–æ –¥–æ–Ω–∞—Ç</div><div class="cl-item-desc">–ù–µ–Ω–∞–≤'—è–∑–ª–∏–≤–µ —Å–ø–ª–∏–≤–∞—é—á–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –ø—Ä–æ—Ö–∞–Ω–Ω—è–º –ø—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–æ—î–∫—Ç. –ß–∞—Å—Ç–æ—Ç–∞ —Ç–∞ —Ç–µ–∫—Å—Ç –Ω–∞–ª–∞—à—Ç–æ–≤—É—é—Ç—å—Å—è –≤ –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—ñ</div></div>
      </div>

      <div class="cl-version">Sky Kharkiv ‚Ä¢ v2.2 ‚Ä¢ 2026</div>

    </div>
  </div>
</div>

<script>
/* ===== DONATE TOAST ===== */
(function(){
  let _dtCfg = null, _dtTimer = null, _dtHideTimer = null, _dtDismissed = false;

  async function loadDonateToastCfg() {
    try {
      const r = await fetch('/api/donate-toast');
      if (r.ok) _dtCfg = await r.json();
    } catch(e) {}
  }

  function showDonateToast() {
    if (_dtDismissed || !_dtCfg || !_dtCfg.enabled) return;
    const el = document.getElementById('donateToast');
    if (!el) return;
    const txt = el.querySelector('.dt-text');
    if (txt && _dtCfg.text) txt.textContent = _dtCfg.text;
    if (_dtCfg.url) el.href = _dtCfg.url;
    el.classList.add('show');
    if (_dtHideTimer) clearTimeout(_dtHideTimer);
    _dtHideTimer = setTimeout(() => { el.classList.remove('show'); }, (_dtCfg.duration_seconds || 5) * 1000);
  }

  window.closeDonateToast = function() {
    const el = document.getElementById('donateToast');
    if (el) el.classList.remove('show');
    _dtDismissed = true;
    if (_dtTimer) { clearInterval(_dtTimer); _dtTimer = null; }
  };

  // Poll for admin-triggered toast (test button)
  let _lastTriggerTs = 0;
  async function pollTrigger() {
    try {
      const r = await fetch('/api/donate-toast/trigger');
      if (r.ok) {
        const d = await r.json();
        if (d.ts && d.ts > _lastTriggerTs && _lastTriggerTs > 0) {
          // Force show even if dismissed
          _dtDismissed = false;
          if (_dtCfg) showDonateToast();
        }
        _lastTriggerTs = d.ts || 0;
      }
    } catch(e) {}
  }

  async function init() {
    await loadDonateToastCfg();
    // Start trigger polling regardless of enabled state (for admin testing)
    pollTrigger();
    setInterval(pollTrigger, 5000);
    if (!_dtCfg || !_dtCfg.enabled) return;
    const interval = (_dtCfg.interval_seconds || 120) * 1000;
    setTimeout(() => {
      showDonateToast();
      _dtTimer = setInterval(showDonateToast, interval);
    }, Math.min(interval / 2, 60000));
  }

  setTimeout(init, 3000);
})();

/* ===== VIEWER COUNTER ===== */
(function(){
  const VID_KEY = 'skykh_viewer_id';
  function getVid(){
    let v = sessionStorage.getItem(VID_KEY);
    if(!v){ v = Math.random().toString(36).slice(2)+Date.now().toString(36); sessionStorage.setItem(VID_KEY,v); }
    return v;
  }
  const vid = getVid();

  async function heartbeat(){
    try{
      const r = await fetch('/api/viewers/heartbeat',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({vid})
      });
      if(r.ok){
        const d = await r.json();
        updateCounterUI(d.count);
      }
    }catch(e){}
  }

  function updateCounterUI(count){
    const el = document.getElementById('viewerCounter');
    if(!el) return;
    const num = el.querySelector('.vc-num');
    if(num) num.textContent = count;
  }

  heartbeat();
  setInterval(heartbeat, 15000);
})();

/* ===== CHANGELOG ===== */
(function(){
  const btn=document.getElementById('changelogBtn'),ov=document.getElementById('changelogOverlay'),cl=document.getElementById('clClose');
  if(!btn||!ov)return;
  btn.addEventListener('click',()=>ov.classList.add('open'));
  cl.addEventListener('click',()=>ov.classList.remove('open'));
  ov.addEventListener('click',e=>{if(e.target===ov)ov.classList.remove('open')});
  document.addEventListener('keydown',e=>{if(e.key==='Escape'&&ov.classList.contains('open'))ov.classList.remove('open')});
})();
</script>

</body>
</html>
