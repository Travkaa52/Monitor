import asyncio
import json
import os
import threading
from datetime import datetime, timedelta
from http.server import SimpleHTTPRequestHandler
from socketserver import TCPServer
from telethon import TelegramClient, events

# --- –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø ---
API_ID = '25635427'
API_HASH = 'e2f99fb35400e6628c88ffd388308598'
BOT_TOKEN = '8377487187:AAFEd-mRZjJaJ_xC0931IkFlLyr09Lwnnwo'
CHANNEL_ID = 'monitorkh1654'
PORT = 8000

# –†–û–ó–®–ò–†–ï–ù–ò–ô –°–õ–û–í–ù–ò–ö –°–õ–ï–ù–ì–£ –¢–ê –¢–ò–ü–Ü–í
TARGET_TYPES = {
    "recon": ["–∑–∞–ª–∞", "zala", "—Ä–æ–∑–≤—ñ–¥", "–æ—Ä–ª–∞–Ω", "—Å—É–ø–µ—Ä–∫–∞–º", "supercam", "–±–µ–∑–ø—ñ–ª–æ—Ç–Ω–∏–∫"],
    "kab": ["–∫–∞–±", "–ø—É—Å–∫", "–∞–≤—ñ–∞–±–æ–º–±–∞", "—Ñ–∞–±", "–∫–µ—Ä–æ–≤–∞–Ω–∞"],
    "aircraft": ["–ø–µ—Ç—É—Ö–∏", "—Å—É-34", "—Å—É-35", "–±–æ—Ä—Ç", "–ª—ñ—Ç–∞–∫", "—Å—É—à–∫–∞"],
    "mrls": ["—Ä—Å–∑–≤", "–≥—Ä–∞–¥", "—Å–º–µ—Ä—á", "—É—Ä–∞–≥–∞–Ω", "–≤–∏—Ö—ñ–¥", "–æ–±—Å—Ç—Ä—ñ–ª"],
    "drone": ["—à–∞—Ö–µ–¥", "–±–ø–ª–∞", "–º–æ–ø–µ–¥", "–≥–µ—Ä–∞–Ω—å", "—à–∞—Ö—ñ–¥"],
    "missile": ["—Ä–∞–∫–µ—Ç–∞", "—ñ—Å–∫–∞–Ω–¥–µ—Ä", "—Ö-101", "–∫–∏–Ω–¥–∂–∞–ª", "–±–∞–ª—ñ—Å—Ç–∏–∫–∞"]
}

# –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–ê –ë–ê–ó–ê –•–ê–†–ö–Ü–í–°–¨–ö–û–á –û–ë–õ–ê–°–¢–Ü (–†–∞–π–æ–Ω–∏ —Ç–∞ –∫–ª—é—á–æ–≤—ñ —Å–µ–ª–∞)
GEO_DATA = {
    # –•–ê–†–ö–Ü–í –¢–ê –ü–ï–†–ï–î–ú–Ü–°–¢–Ø
    "—Ö–∞—Ä–∫—ñ–≤": [49.99, 36.23, "–û–±–ª–∞—Å–Ω–∏–π —Ü–µ–Ω—Ç—Ä"],
    "—Ö–∞—Ä—å–∫–æ–≤": [49.99, 36.23, "–û–±–ª–∞—Å–Ω–∏–π —Ü–µ–Ω—Ç—Ä"],
    "–ø—ñ—Å–æ—á–∏–Ω": [49.95, 36.10, "–•–∞—Ä–∫—ñ–≤—Å—å–∫–∏–π —Ä-–Ω"],
    "—Å–æ–ª–æ–Ω–∏—Ü—ñ–≤–∫–∞": [50.01, 36.05, "–•–∞—Ä–∫—ñ–≤—Å—å–∫–∏–π —Ä-–Ω"],
    "–ª—é–±–æ—Ç–∏–Ω": [49.94, 35.92, "–•–∞—Ä–∫—ñ–≤—Å—å–∫–∏–π —Ä-–Ω"],
    "–º–µ—Ä–µ—Ñ–∞": [49.82, 36.05, "–•–∞—Ä–∫—ñ–≤—Å—å–∫–∏–π —Ä-–Ω"],
    "—Ü–∏—Ä–∫—É–Ω–∏": [50.07, 36.38, "–•–∞—Ä–∫—ñ–≤—Å—å–∫–∏–π —Ä-–Ω"],
    "–ª–∏–ø—Ü—ñ": [50.20, 36.42, "–•–∞—Ä–∫—ñ–≤—Å—å–∫–∏–π —Ä-–Ω"],
    "—Ä—É—Å—å–∫–∞ –ª–æ–∑–æ–≤–∞": [50.13, 36.29, "–•–∞—Ä–∫—ñ–≤—Å—å–∫–∏–π —Ä-–Ω"],
    "–∫—É—Ç—É–∑—ñ–≤–∫–∞": [50.02, 36.46, "–•–∞—Ä–∫—ñ–≤—Å—å–∫–∏–π —Ä-–Ω"],
    "–∫–æ–∑–∞—á–∞ –ª–æ–ø–∞–Ω—å": [50.33, 36.19, "–•–∞—Ä–∫—ñ–≤—Å—å–∫–∏–π —Ä-–Ω"],
    "–¥–µ—Ä–≥–∞—á—ñ": [50.11, 36.12, "–•–∞—Ä–∫—ñ–≤—Å—å–∫–∏–π —Ä-–Ω"],

    # –ß–£–ì–£–á–í–°–¨–ö–ò–ô –ù–ê–ü–†–Ø–ú–û–ö
    "—á—É–≥—É—ó–≤": [49.83, 36.68, "–ß—É–≥—É—ó–≤—Å—å–∫–∏–π —Ä-–Ω"],
    "–≤–æ–≤—á–∞–Ω—Å—å–∫": [50.28, 36.93, "–ß—É–≥—É—ó–≤—Å—å–∫–∏–π —Ä-–Ω"],
    "—Å—Ç–∞—Ä–∏–π —Å–∞–ª—Ç—ñ–≤": [50.08, 36.79, "–ß—É–≥—É—ó–≤—Å—å–∫–∏–π —Ä-–Ω"],
    "–º–∞–ª–∏–Ω—ñ–≤–∫–∞": [49.79, 36.72, "–ß—É–≥—É—ó–≤—Å—å–∫–∏–π —Ä-–Ω"],
    "–ø–µ—á–µ–Ω—ñ–≥–∏": [49.86, 36.93, "–ß—É–≥—É—ó–≤—Å—å–∫–∏–π —Ä-–Ω"],
    "–±—ñ–ª–∏–π –∫–æ–ª–æ–¥—è–∑—å": [50.20, 37.14, "–ß—É–≥—É—ó–≤—Å—å–∫–∏–π —Ä-–Ω"],
    "–≤–æ–≤—á–∞–Ω—Å—å–∫—ñ —Ö—É—Ç–æ—Ä–∏": [50.28, 37.03, "–ß—É–≥—É—ó–≤—Å—å–∫–∏–π —Ä-–Ω"],

    # –ö–£–ü'–Ø–ù–°–¨–ö–ò–ô –ù–ê–ü–†–Ø–ú–û–ö
    "–∫—É–ø'—è–Ω—Å—å–∫": [49.70, 37.61, "–ö—É–ø'—è–Ω—Å—å–∫–∏–π —Ä-–Ω"],
    "–≤—É–∑–ª–æ–≤–∞": [49.67, 37.64, "–ö—É–ø'—è–Ω—Å—å–∫-–í—É–∑–ª–æ–≤–∏–π"],
    "–∫—ñ–≤—à–∞—Ä—ñ–≤–∫–∞": [49.62, 37.68, "–ö—É–ø'—è–Ω—Å—å–∫–∏–π —Ä-–Ω"],
    "—à–µ–≤—á–µ–Ω–∫–æ–≤–µ": [49.70, 37.17, "–ö—É–ø'—è–Ω—Å—å–∫–∏–π —Ä-–Ω"],
    "–¥–≤–æ—Ä—ñ—á–Ω–∞": [49.85, 37.67, "–ö—É–ø'—è–Ω—Å—å–∫–∏–π —Ä-–Ω"],
    "–±–æ—Ä–æ—Å—Ç–µ": [49.33, 37.62, "–ë–æ—Ä—ñ–≤—Å—å–∫–∞ –≥—Ä–æ–º–∞–¥–∞"],

    # –Ü–ó–Æ–ú–°–¨–ö–ò–ô –ù–ê–ü–†–Ø–ú–û–ö
    "—ñ–∑—é–º": [49.19, 37.27, "–Ü–∑—é–º—Å—å–∫–∏–π —Ä-–Ω"],
    "–±–∞–ª–∞–∫–ª—ñ—è": [49.45, 36.85, "–Ü–∑—é–º—Å—å–∫–∏–π —Ä-–Ω"],
    "–¥–æ–Ω–µ—Ü—å": [49.46, 36.50, "–Ü–∑—é–º—Å—å–∫–∏–π —Ä-–Ω"],
    "—Å–∞–≤–∏–Ω—Ü—ñ": [49.40, 36.99, "–Ü–∑—é–º—Å—å–∫–∏–π —Ä-–Ω"],

    # –ë–û–ì–û–î–£–•–Ü–í–°–¨–ö–ò–ô –ù–ê–ü–†–Ø–ú–û–ö
    "–±–æ–≥–æ–¥—É—Ö—ñ–≤": [50.16, 35.52, "–ë–æ–≥–æ–¥—É—Ö—ñ–≤—Å—å–∫–∏–π —Ä-–Ω"],
    "–∑–æ–ª–æ—á—ñ–≤": [50.28, 35.97, "–ë–æ–≥–æ–¥—É—Ö—ñ–≤—Å—å–∫–∏–π —Ä-–Ω"],
    "–≤–∞–ª–∫–∏": [49.83, 35.61, "–ë–æ–≥–æ–¥—É—Ö—ñ–≤—Å—å–∫–∏–π —Ä-–Ω"],
    "–≤—ñ–¥—Ä–æ–¥–∂–µ–Ω—ñ–≤—Å—å–∫–µ": [50.31, 35.84, "–ó–æ–ª–æ—á—ñ–≤—Å—å–∫–∞ –≥—Ä–æ–º–∞–¥–∞"],

    # –ü–Ü–í–î–ï–ù–¨ –û–ë–õ–ê–°–¢–Ü
    "–ª–æ–∑–æ–≤–∞": [48.88, 36.31, "–õ–æ–∑—ñ–≤—Å—å–∫–∏–π —Ä-–Ω"],
    "–ø–µ—Ä–≤–æ–º–∞–π—Å—å–∫–∏–π": [49.38, 36.21, "–õ–æ–∑—ñ–≤—Å—å–∫–∏–π —Ä-–Ω"],
    "–∫—Ä–∞—Å–Ω–æ–≥—Ä–∞–¥": [49.37, 35.45, "–ö—Ä–∞—Å–Ω–æ–≥—Ä–∞–¥—Å—å–∫–∏–π —Ä-–Ω"]
}

active_targets = []
BASE_DIR = os.path.dirname(os.path.abspath(__file__))

def save_targets():
    with open(os.path.join(BASE_DIR, 'targets.json'), 'w', encoding='utf-8') as f:
        json.dump(active_targets, f, ensure_ascii=False, indent=4)

async def cleaner():
    global active_targets
    while True:
        now = datetime.now()
        # –ó–∞–ª–∏—à–∞—î–º–æ —Ü—ñ–ª—ñ, —è–∫–∏–º –º–µ–Ω—à–µ 40 —Ö–≤–∏–ª–∏–Ω
        active_targets = [t for t in active_targets if datetime.fromisoformat(t['expire_at']) > now]
        save_targets()
        await asyncio.sleep(60)

def start_server():
    os.chdir(BASE_DIR)
    TCPServer.allow_reuse_address = True
    with TCPServer(("", PORT), SimpleHTTPRequestHandler) as httpd:
        httpd.serve_forever()

client = TelegramClient('bot_session', API_ID, API_HASH)

@client.on(events.NewMessage(chats=CHANNEL_ID))
async def handler(event):
    text = event.raw_text.lower()
    now = datetime.now()
    
    # –í–∏–∑–Ω–∞—á–∞—î–º–æ –¢–ò–ü
    detected_type = "missile"
    for t_name, keywords in TARGET_TYPES.items():
        if any(word in text for word in keywords):
            detected_type = t_name
            break

    # –í–∏–∑–Ω–∞—á–∞—î–º–æ –ú–Ü–°–¢–û
    for city, data in GEO_DATA.items():
        if city in text:
            # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –Ω–µ–º–∞—î –≤–∂–µ —Ç–∞–∫–æ—ó —Ü—ñ–ª—ñ –ø–æ—Ä—É—á (—â–æ–± –Ω–µ –¥—É–±–ª—é–≤–∞—Ç–∏)
            is_duplicate = any(t['label'].startswith(city.capitalize()) and t['type'] == detected_type for t in active_targets)
            
            if not is_duplicate:
                target = {
                    "id": event.id,
                    "type": detected_type,
                    "lat": data[0],
                    "lng": data[1],
                    "label": f"{city.capitalize()} ({data[2]})",
                    "time": now.strftime("%H:%M"),
                    "expire_at": (now + timedelta(minutes=40)).isoformat()
                }
                active_targets.append(target)
                save_targets()
                print(f"‚úÖ {detected_type.upper()} -> {city.capitalize()}")
                break

async def main():
    threading.Thread(target=start_server, daemon=True).start()
    asyncio.create_task(cleaner())
    print("ü§ñ –°–∏—Å—Ç–µ–º–∞ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –•–∞—Ä–∫—ñ–≤—â–∏–Ω–∏ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–∞!")
    await client.start(bot_token=BOT_TOKEN)
    await client.run_until_disconnected()

if __name__ == '__main__':
    asyncio.run(main())